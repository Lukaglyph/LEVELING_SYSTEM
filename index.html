<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVELING_SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@300;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --system-blue: #00e5ff;
            --system-bg: rgba(10, 20, 30, 0.95);
            --system-border: rgba(0, 229, 255, 0.5);
        }

        body {
            background-color: #050a10;
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(0, 50, 100, 0.2) 0%, transparent 80%),
                linear-gradient(rgba(0, 229, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 229, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            font-family: 'Noto Sans JP', sans-serif;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .system-font { font-family: 'Orbitron', sans-serif; }

        .quest-window {
            background: var(--system-bg);
            border: 2px solid var(--system-border);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.15);
            backdrop-filter: blur(12px);
            position: relative;
            clip-path: polygon(0 0, 97% 0, 100% 3%, 100% 100%, 3% 100%, 0 97%);
        }

        .rank-badge {
            padding: 2px 12px;
            font-size: 0.75rem;
            font-weight: bold;
            border: 1px solid currentColor;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }

        .rank-E { color: #9e9e9e; }
        .rank-D { color: #4caf50; }
        .rank-C { color: #2196f3; }
        .rank-B { color: #9c27b0; }
        .rank-A { color: #ff9800; }
        .rank-S { color: #f44336; text-shadow: 0 0 10px #f44336; }

        .exp-bar-container {
            background: rgba(255, 255, 255, 0.05);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .exp-bar-fill {
            background: linear-gradient(90deg, #008cff, var(--system-blue));
            height: 100%;
            width: 0%;
            transition: width 0.6s ease;
            box-shadow: 0 0 10px var(--system-blue);
        }

        .btn-quest {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(0, 229, 255, 0.1);
            transition: all 0.2s;
        }

        .btn-quest:not(:disabled):hover {
            background: rgba(0, 229, 255, 0.08);
            border-color: var(--system-blue);
            transform: translateX(5px);
        }

        .btn-quest:disabled {
            opacity: 0.3;
            filter: grayscale(1);
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #0d1620;
            border: 1px solid var(--system-blue);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 2rem;
            box-shadow: 0 0 50px rgba(0, 229, 255, 0.3);
        }

        .levelup-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            text-align: center;
            animation: levelup-anim 2s forwards;
            pointer-events: none;
        }

        @keyframes levelup-anim {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
        }

        input, select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 229, 255, 0.3);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            outline: none;
        }
        
        input:focus { border-color: var(--system-blue); }

        .name-display:hover {
            cursor: pointer;
            text-shadow: 0 0 8px var(--system-blue);
        }
    </style>
</head>
<body>

    <!-- Level Up Popup -->
    <div id="levelup-popup" class="levelup-popup">
        <h2 class="system-font text-6xl font-bold text-cyan-400 italic">LEVEL UP</h2>
        <p class="text-xl tracking-widest mt-2">PLAYER RANK ASCENDED</p>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2 class="system-font text-xl mb-4 border-b border-cyan-500 pb-2 text-cyan-400">QUEST EDITOR</h2>
            <div id="edit-list" class="space-y-4 mb-6">
                <!-- Editable items -->
            </div>
            <button onclick="addNewQuestTemplate()" class="w-full py-2 border border-dashed border-cyan-500 text-cyan-500 text-xs mb-6 hover:bg-cyan-500/10 tracking-widest">+ ADD NEW QUEST</button>
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 py-2 bg-gray-800 text-xs tracking-widest">CANCEL</button>
                <button onclick="saveQuests()" class="flex-1 py-2 bg-cyan-600 text-xs tracking-widest font-bold">APPLY CHANGES</button>
            </div>
        </div>
    </div>

    <div class="quest-window w-full max-w-lg p-8">
        <!-- Status Header -->
        <div class="flex justify-between items-start mb-8">
            <div class="flex-1">
                <div class="flex items-center gap-3 mb-1">
                    <span id="rank-label" class="system-font rank-badge rank-E">E-RANK</span>
                    <h1 class="system-font text-sm tracking-tighter opacity-80 text-cyan-100">PLAYER STATUS</h1>
                </div>
                <div id="name-container" class="text-4xl system-font font-bold flex items-center group">
                    <span id="player-name" class="name-display" onclick="editName()">user</span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-[10px] opacity-50 system-font">LEVEL</div>
                <div id="lv-display" class="text-5xl system-font text-cyan-400 leading-none">01</div>
            </div>
        </div>

        <!-- EXP Progress -->
        <div class="mb-10">
            <div class="flex justify-between text-[10px] system-font mb-2 tracking-widest">
                <span>EXP PROGRESS</span>
                <span id="exp-nums">0 / 100</span>
            </div>
            <div class="exp-bar-container">
                <div id="exp-fill" class="exp-bar-fill"></div>
            </div>
        </div>

        <!-- Daily Quests -->
        <div class="space-y-3">
            <div class="flex items-center justify-between mb-4">
                <h2 class="system-font text-sm tracking-widest text-cyan-500 uppercase">Daily Quest</h2>
                <button onclick="openModal()" class="text-[10px] bg-cyan-900/40 border border-cyan-500/50 px-3 py-1 hover:bg-cyan-500 hover:text-black transition-all">EDIT</button>
            </div>

            <div id="quest-container" class="space-y-3">
                <!-- Quests -->
            </div>
        </div>

        <!-- Stats -->
        <div class="mt-10 pt-6 border-t border-cyan-500/20 grid grid-cols-3 gap-4">
            <div class="text-center">
                <div class="text-[9px] opacity-40 system-font">STRENGTH</div>
                <div id="stat-str" class="system-font text-lg">10</div>
            </div>
            <div class="text-center">
                <div class="text-[9px] opacity-40 system-font">AGILITY</div>
                <div id="stat-agi" class="system-font text-lg">10</div>
            </div>
            <div class="text-center">
                <div class="text-[9px] opacity-40 system-font">INTELLIGENCE</div>
                <div id="stat-int" class="system-font text-lg">10</div>
            </div>
        </div>
        
        <div class="mt-6 flex justify-between items-center">
            <button onclick="resetData()" class="text-[8px] text-red-500/50 hover:text-red-500 transition-colors uppercase tracking-widest">Reset System Data</button>
            <span id="daily-date" class="text-[10px] opacity-40 system-font">2026.02.28</span>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'solo_leveling_v3_save';
        
        // Default quest definitions
        const defaultQuests = [
            { id: Date.now() + 1, name: '腕立て伏せ', baseCount: 10, unit: '回', stat: 'str', isVariable: true, exp: 20 },
            { id: Date.now() + 2, name: '腹筋', baseCount: 10, unit: '回', stat: 'str', isVariable: true, exp: 20 },
            { id: Date.now() + 3, name: 'スクワット', baseCount: 10, unit: '回', stat: 'str', isVariable: true, exp: 20 },
            { id: Date.now() + 4, name: 'イラスト制作', baseCount: 1, unit: '作品', stat: 'agi', isVariable: false, exp: 30 },
            { id: Date.now() + 5, name: 'プログラミング', baseCount: 1, unit: 'タスク', stat: 'int', isVariable: false, exp: 40 }
        ];

        let state = {
            playerName: 'user',
            level: 1,
            exp: 0,
            stats: { str: 10, agi: 10, int: 10 },
            questDefinitions: [...defaultQuests],
            completedToday: [],
            lastUpdate: new Date().toDateString()
        };

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                const today = new Date().toDateString();
                // Check for new day reset
                if (parsed.lastUpdate !== today) {
                    parsed.completedToday = [];
                    parsed.lastUpdate = today;
                }
                state = { ...state, ...parsed };
                // Ensure IDs exist for legacy saves
                state.questDefinitions.forEach(q => { if(!q.id) q.id = Math.random(); });
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function getRank(lv) {
            if (lv >= 91) return { label: 'S-RANK', class: 'rank-S' };
            if (lv >= 71) return { label: 'A-RANK', class: 'rank-A' };
            if (lv >= 51) return { label: 'B-RANK', class: 'rank-B' };
            if (lv >= 31) return { label: 'C-RANK', class: 'rank-C' };
            if (lv >= 11) return { label: 'D-RANK', class: 'rank-D' };
            return { label: 'E-RANK', class: 'rank-E' };
        }

        function getMultiplier(lv) {
            return Math.min(10, Math.floor((lv - 1) / 10) + 1);
        }

        function getNextLvExp(lv) {
            return 100 + (lv - 1) * 50;
        }

        function renderQuests() {
            const container = document.getElementById('quest-container');
            const mult = getMultiplier(state.level);
            
            container.innerHTML = state.questDefinitions.map(q => {
                const count = q.isVariable ? (q.baseCount * mult) : q.baseCount;
                const expGain = q.exp * (q.isVariable ? mult : 1);
                const isDone = state.completedToday.includes(q.id);
                
                return `
                    <button onclick="completeQuest(${q.id}, ${expGain}, '${q.stat}')" 
                            id="btn-${q.id}" 
                            ${isDone ? 'disabled' : ''}
                            class="btn-quest w-full p-4 flex justify-between items-center rounded-sm text-left">
                        <div class="flex items-center gap-4">
                            <div class="w-1 h-8 ${isDone ? 'bg-gray-500' : 'bg-cyan-500/40'}"></div>
                            <div>
                                <div class="text-[10px] opacity-50 system-font uppercase">${q.stat} TRAINING</div>
                                <div class="font-bold tracking-wider">${q.name} ${count}${q.unit}</div>
                            </div>
                        </div>
                        <div class="system-font ${isDone ? 'text-gray-500' : 'text-cyan-400'} text-sm">
                            ${isDone ? 'CLEARED' : `+${expGain} XP`}
                        </div>
                    </button>
                `;
            }).join('');
        }

        function updateUI() {
            const rank = getRank(state.level);
            const nextExp = getNextLvExp(state.level);
            
            document.getElementById('player-name').innerText = state.playerName;
            
            const badge = document.getElementById('rank-label');
            badge.innerText = rank.label;
            badge.className = `system-font rank-badge ${rank.class}`;
            
            document.getElementById('lv-display').innerText = state.level.toString().padStart(2, '0');
            document.getElementById('exp-nums').innerText = `${state.exp} / ${nextExp}`;
            document.getElementById('exp-fill').style.width = `${(state.exp / nextExp) * 100}%`;
            
            document.getElementById('stat-str').innerText = state.stats.str;
            document.getElementById('stat-agi').innerText = state.stats.agi;
            document.getElementById('stat-int').innerText = state.stats.int;

            renderQuests();
        }

        function completeQuest(id, xp, stat) {
            if (state.completedToday.includes(id)) return;
            
            state.completedToday.push(id);
            state.exp += xp;
            state.stats[stat] += 1;

            const nextExp = getNextLvExp(state.level);
            if (state.exp >= nextExp) {
                levelUp(nextExp);
            }
            
            saveData();
            updateUI();
        }

        function levelUp(nextExp) {
            state.level++;
            state.exp -= nextExp;
            state.stats.int += 2;
            
            const popup = document.getElementById('levelup-popup');
            popup.style.display = 'block';
            setTimeout(() => { popup.style.display = 'none'; }, 2000);
        }

        /* Modal Logic */
        function openModal() {
            document.getElementById('edit-modal').style.display = 'flex';
            renderEditList();
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function renderEditList() {
            const list = document.getElementById('edit-list');
            list.innerHTML = state.questDefinitions.map((q, idx) => `
                <div class="p-3 border border-cyan-500/20 bg-cyan-900/10 rounded flex flex-col gap-2">
                    <div class="flex justify-between gap-2">
                        <input type="text" placeholder="クエスト名" class="flex-1 text-sm" value="${q.name}" onchange="updateTempQuest(${idx}, 'name', this.value)">
                        <button onclick="removeQuest(${idx})" class="text-red-500 text-xs px-2">削除</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="flex flex-col">
                            <label class="text-[9px] opacity-50">達成数 / 単位</label>
                            <div class="flex">
                                <input type="number" class="w-16 text-sm" value="${q.baseCount}" onchange="updateTempQuest(${idx}, 'baseCount', parseInt(this.value))">
                                <input type="text" class="w-16 text-sm" value="${q.unit}" onchange="updateTempQuest(${idx}, 'unit', this.value)">
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[9px] opacity-50">獲得XP / ステータス</label>
                            <div class="flex">
                                <input type="number" class="w-16 text-sm" value="${q.exp}" onchange="updateTempQuest(${idx}, 'exp', parseInt(this.value))">
                                <select class="text-xs" onchange="updateTempQuest(${idx}, 'stat', this.value)">
                                    <option value="str" ${q.stat === 'str' ? 'selected' : ''}>STR</option>
                                    <option value="agi" ${q.stat === 'agi' ? 'selected' : ''}>AGI</option>
                                    <option value="int" ${q.stat === 'int' ? 'selected' : ''}>INT</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="var-${idx}" ${q.isVariable ? 'checked' : ''} onchange="updateTempQuest(${idx}, 'isVariable', this.checked)">
                        <label for="var-${idx}" class="text-[10px]">ランクに応じて回数を増やす</label>
                    </div>
                </div>
            `).join('');
        }

        function updateTempQuest(idx, field, value) {
            state.questDefinitions[idx][field] = value;
        }

        function addNewQuestTemplate() {
            state.questDefinitions.push({
                id: Date.now(),
                name: '新クエスト',
                baseCount: 1,
                unit: '回',
                stat: 'str',
                isVariable: false,
                exp: 10
            });
            renderEditList();
        }

        function removeQuest(idx) {
            state.questDefinitions.splice(idx, 1);
            renderEditList();
        }

        function saveQuests() {
            saveData();
            updateUI();
            closeModal();
        }

        function editName() {
            const current = state.playerName;
            const newName = prompt("プレイヤー名を入力してください", current);
            if (newName) {
                state.playerName = newName;
                saveData();
                updateUI();
            }
        }

        function resetData() {
            if (confirm('すべての進捗とカスタム設定を初期化しますか？')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // Init
        loadData();
        document.getElementById('daily-date').innerText = new Date().toLocaleDateString('ja-JP').replace(/\//g, '.');
        updateUI();
    </script>
</body>
</html>

